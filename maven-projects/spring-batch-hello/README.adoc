== Example to parse JSON

. Creating a new project, and go to the projects directory.
+
[source,console]
----
$ mvn -B archetype:generate -DarchetypeGroupId=org.apache.maven.archetypes -D groupId=com.example -DarchetypeVersion=1.0 -DartifactId=spring-batch-hello
----
+
----
cd json-parse
----

. Update pom.xml
+
[source,diff]
.pom.xml
----
@@ -4,15 +4,50 @@
   <groupId>com.example</groupId>
   <artifactId>spring-batch-hello</artifactId>
   <packaging>jar</packaging>
   <version>1.0-SNAPSHOT</version>
   <name>spring-batch-hello</name>
-  <url>http://maven.apache.org</url>
+  <url>http://www.example.com</url>
+  <properties>
+    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
+    <maven.compiler.source>1.8</maven.compiler.source>
+    <maven.compiler.target>1.8</maven.compiler.target>
+  </properties>
+  <build>
+    <plugins>
+      <!-- https://mvnrepository.com/artifact/org.codehaus.mojo/exec-maven-plugin -->
+      <plugin>
+        <groupId>org.codehaus.mojo</groupId>
+        <artifactId>exec-maven-plugin</artifactId>
+        <version>3.0.0</version>
+        <executions>
+          <execution>
+            <goals>
+              <goal>java</goal>
+            </goals>
+          </execution>
+        </executions>
+        <configuration>
+          <mainClass>com.example.App</mainClass>
+        </configuration>
+      </plugin>
+    </plugins>
+  </build>
   <dependencies>
     <dependency>
       <groupId>junit</groupId>
       <artifactId>junit</artifactId>
       <version>3.8.1</version>
       <scope>test</scope>
     </dependency>
+    <dependency>
+      <groupId>org.springframework.batch</groupId>
+      <artifactId>spring-batch-core</artifactId>
+      <version>4.2.0.RELEASE</version>
+    </dependency>
+    <dependency>
+      <groupId>commons-logging</groupId>
+      <artifactId>commons-logging</artifactId>
+      <version>1.1.1</version>
+    </dependency>
   </dependencies>
 </project>
----

. Source
+
[source,java]
.src/main/java/com/example/App.java
----
package com.example;

import org.springframework.batch.core.Job;
import org.springframework.batch.core.JobExecution;
import org.springframework.batch.core.JobParameters;
import org.springframework.batch.core.JobParametersBuilder;
import org.springframework.batch.core.JobParametersInvalidException;
import org.springframework.batch.core.launch.JobLauncher;
import org.springframework.batch.core.repository.JobExecutionAlreadyRunningException;
import org.springframework.batch.core.repository.JobInstanceAlreadyCompleteException;
import org.springframework.batch.core.repository.JobRestartException;
import org.springframework.context.ApplicationContext;
import org.springframework.context.annotation.AnnotationConfigApplicationContext;

/**
 * Hello world!
 *
 */
public class App 
{
    public static void main( String[] args )
    {
        ApplicationContext context = new AnnotationConfigApplicationContext(SpringBatchHelloWorldConfig.class);

        JobLauncher jobLauncher = context.getBean(JobLauncher.class);
        Job job = context.getBean("listEmployeesJob", Job.class);

        JobParameters jobParameters = new JobParametersBuilder().toJobParameters();
    
        try {
            JobExecution jobExecution = jobLauncher.run(job, jobParameters);
        }
        catch (JobExecutionAlreadyRunningException e) {
            e.printStackTrace();
        }
        catch (JobRestartException e) {
            e.printStackTrace();
        }
        catch (JobInstanceAlreadyCompleteException e) {
            e.printStackTrace();
        }
        catch (JobParametersInvalidException e) {
            e.printStackTrace();
        }
    }
}
----
+
[source,java]
.src/main/java/com/example/Employee.java
----
package com.example;

public class Employee {
  private String firstName;
  private String lastName;
  private int age;
  private int salary;

  public String getFirstName() {
    return firstName;
  }

  public void setFirstName(String firstName) {
    this.firstName = firstName;
  }

  public String getLastName() {
    return lastName;
  }

  public void setLastName(String lastName) {
    this.lastName = lastName;
  }

  public int getAge() {
    return age;
  }

  public void setAge(int age) {
    this.age = age;
  }

  public int getSalary() {
    return salary;
  }

  public void setSalary(int salary) {
    this.salary = salary;
  }
}
----
+
[source,csv]
.src/main/resources/employees.csv
----
John,Doe,35,90000
Sue,Smith,45,95000
Joe,Brown,33,86000
Carol,Dunn,25,75000
Mike,Ward,23,70000
Lisa,Jones,22,69000
----
+
[source,java]
.src/main/java/com/example/SpringBatchHelloWorldConfig.java
----
package com.example;

import java.util.List;

import org.springframework.batch.core.Job;
import org.springframework.batch.core.Step;
import org.springframework.batch.core.configuration.annotation.EnableBatchProcessing;
import org.springframework.batch.core.configuration.annotation.JobBuilderFactory;
import org.springframework.batch.core.configuration.annotation.StepBuilderFactory;
import org.springframework.batch.item.ItemProcessor;
import org.springframework.batch.item.ItemReader;
import org.springframework.batch.item.ItemWriter;
import org.springframework.batch.item.file.FlatFileItemReader;
import org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper;
import org.springframework.batch.item.file.mapping.DefaultLineMapper;
import org.springframework.batch.item.file.transform.DelimitedLineTokenizer;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.ClassPathResource;

@Configuration
@EnableBatchProcessing
public class SpringBatchHelloWorldConfig {

    @Autowired
    private JobBuilderFactory jobBuilderFactory;

    @Autowired
    private StepBuilderFactory stepBuilderFactory;

    @Bean
    public Step step1() {
        return stepBuilderFactory.get("step1")
                .<Employee, Employee>chunk(2)
                .reader(employeeItemReader())
                .processor(employeeItemProcessor())
                .writer(employeeItemWriter())
                .build();
    }

    @Bean
    public Job listEmployeesJob(Step step1) throws Exception {
        return jobBuilderFactory.get("listEmployeesJob")
                .start(step1)
                .build();
    }

    @Bean
    ItemReader<Employee> employeeItemReader() {
        
        FlatFileItemReader<Employee> reader = new FlatFileItemReader<>();
        reader.setResource(new ClassPathResource("employees.csv"));

        DefaultLineMapper defaultLineMapper = new DefaultLineMapper();
        DelimitedLineTokenizer delimitedLineTokenizer = new DelimitedLineTokenizer();
        delimitedLineTokenizer.setNames(new String[] {"firstName", "lastName", "age", "salary"});

        BeanWrapperFieldSetMapper<Employee> fieldSetMapper = new BeanWrapperFieldSetMapper<>();
        fieldSetMapper.setTargetType(Employee.class);

        defaultLineMapper.setLineTokenizer(delimitedLineTokenizer);
        defaultLineMapper.setFieldSetMapper(fieldSetMapper);
        reader.setLineMapper(defaultLineMapper);

        return reader;
    }

    @Bean
    ItemProcessor<Employee, Employee> employeeItemProcessor() {
        return new ItemProcessor<Employee, Employee>() {
            @Override
            public Employee process(Employee employee) throws Exception {
                employee.setFirstName(employee.getFirstName().toUpperCase());
                employee.setLastName(employee.getLastName().toUpperCase());
                return employee;
            }
        };
    }
    
    @Bean
    ItemWriter<Employee> employeeItemWriter() {
        return new ItemWriter<Employee>() {
            @Override
            public void write(List<? extends Employee> employeesList) throws Exception {
                for (Employee employee : employeesList) {
                    System.out.println("Name: "
                            + employee.getFirstName() + " "
                            + employee.getLastName() + "; "
                            + "Age: " + employee.getAge() + "; "
                            + "Salary: " + employee.getSalary());
                }
            }
        };
    }
}
----

. Build the Project
+
[source,console]
----
$ mvn compile
----

. Run App
+
[source,console]
----
$ mvn exec:java
[INFO] Scanning for projects...
[INFO]
[INFO] -------------------< com.example:spring-batch-hello >-------------------
[INFO] Building spring-batch-hello 1.0-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------
[INFO]
[INFO] --- exec-maven-plugin:3.0.0:java (default-cli) @ spring-batch-hello ---
Apr 12, 2022 2:24:51 PM org.springframework.batch.core.configuration.annotation.DefaultBatchConfigurer initialize
WARNING: No datasource was provided...using a Map based JobRepository
Apr 12, 2022 2:24:51 PM org.springframework.batch.core.configuration.annotation.DefaultBatchConfigurer initialize
WARNING: No transaction manager was provided, using a ResourcelessTransactionManager
Apr 12, 2022 2:24:51 PM org.springframework.batch.core.launch.support.SimpleJobLauncher afterPropertiesSet
INFO: No TaskExecutor has been set, defaulting to synchronous executor.
Apr 12, 2022 2:24:51 PM org.springframework.batch.core.launch.support.SimpleJobLauncher$1 run
INFO: Job: [SimpleJob: [name=listEmployeesJob]] launched with the following parameters: [{}]
Apr 12, 2022 2:24:52 PM org.springframework.batch.core.job.SimpleStepHandler handleStep
INFO: Executing step: [step1]
Name: JOHN DOE; Age: 35; Salary: 90000
Name: SUE SMITH; Age: 45; Salary: 95000
Name: JOE BROWN; Age: 33; Salary: 86000
Name: CAROL DUNN; Age: 25; Salary: 75000
Name: MIKE WARD; Age: 23; Salary: 70000
Name: LISA JONES; Age: 22; Salary: 69000
Apr 12, 2022 2:24:52 PM org.springframework.batch.core.step.AbstractStep execute
INFO: Step: [step1] executed in 251ms
Apr 12, 2022 2:24:52 PM org.springframework.batch.core.launch.support.SimpleJobLauncher$1 run
INFO: Job: [SimpleJob: [name=listEmployeesJob]] completed with the following parameters: [{}] and the following status: [COMPLETED] in 370ms
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  3.496 s
[INFO] Finished at: 2022-04-12T14:24:52+09:00
[INFO] ------------------------------------------------------------------------
----

. Make a package
+
[source,console]
----
$ mvn package
----

. Copy dependencies.
+
[source,console]
----
mvn dependency:copy-dependencies
----
+
[source,console]
----
$ tree target/dependency
target/dependency
├── HdrHistogram-2.1.11.jar
├── LatencyUtils-2.0.3.jar
├── commons-logging-1.1.1.jar
├── jackson-annotations-2.10.0.jar
├── jackson-core-2.10.0.jar
├── jackson-databind-2.10.0.jar
├── javax.batch-api-1.0.jar
├── jettison-1.2.jar
├── junit-3.8.1.jar
├── micrometer-core-1.3.0.jar
├── spring-aop-5.2.0.RELEASE.jar
├── spring-batch-core-4.2.0.RELEASE.jar
├── spring-batch-infrastructure-4.2.0.RELEASE.jar
├── spring-beans-5.2.0.RELEASE.jar
├── spring-context-5.2.0.RELEASE.jar
├── spring-core-5.2.0.RELEASE.jar
├── spring-expression-5.2.0.RELEASE.jar
├── spring-jcl-5.2.0.RELEASE.jar
├── spring-retry-1.2.4.RELEASE.jar
└── spring-tx-5.2.0.RELEASE.jar
----

. You may test the newly compiled and packaged JAR with the following command:
+
[source,console]
----
$ java -cp target/spring-batch-hello-1.0-SNAPSHOT.jar:target/dependency/...
...
----

. cleans up artifacts created by prior builds
+
[source,console]
----
mvn clean
----

=== Notes

==== Resource leak: 'context' is never closed

[source,java]
----
public class App 
{
    public static void main( String[] args )
    {
        ApplicationContext context = new AnnotationConfigApplicationContext(SpringBatchHelloWorldConfig.class);
        // ...
    }
}
----

----
Resource leak: 'context' is never closed
----

[source,diff]
----
@@ -7,22 +7,22 @@ import org.springframework.batch.core.JobParametersBuilder;
 import org.springframework.batch.core.JobParametersInvalidException;
 import org.springframework.batch.core.launch.JobLauncher;
 import org.springframework.batch.core.repository.JobExecutionAlreadyRunningException;
 import org.springframework.batch.core.repository.JobInstanceAlreadyCompleteException;
 import org.springframework.batch.core.repository.JobRestartException;
-import org.springframework.context.ApplicationContext;
+import org.springframework.context.ConfigurableApplicationContext;
 import org.springframework.context.annotation.AnnotationConfigApplicationContext;

 /**
  * Hello world!
  *
  */
 public class App
 {
     public static void main( String[] args )
     {
-        ApplicationContext context = new AnnotationConfigApplicationContext(SpringBatchHelloWorldConfig.class);
+        ConfigurableApplicationContext context = new AnnotationConfigApplicationContext(SpringBatchHelloWorldConfig.class);

         JobLauncher jobLauncher = context.getBean(JobLauncher.class);
         Job job = context.getBean("listEmployeesJob", Job.class);

         JobParameters jobParameters = new JobParametersBuilder().toJobParameters();
@@ -39,8 +39,10 @@ public class App
         catch (JobInstanceAlreadyCompleteException e) {
             e.printStackTrace();
         }
         catch (JobParametersInvalidException e) {
             e.printStackTrace();
+        } finally {
+            context.close();
         }
     }
 }
----

.References
* https://stackoverflow.com/questions/17270066/closing-a-spring-applicationcontext[java - Closing a Spring ApplicationContext - Stack Overflow^]
* https://spring.pleiades.io/spring-framework/docs/current/javadoc-api/org/springframework/context/ConfigurableApplicationContext.html[ConfigurableApplicationContext (Spring Framework 5.3.18 API) - Javadoc^]

== References
* https://learntutorials.net/ja/spring-batch/topic/4089/%E3%82%B9%E3%83%97%E3%83%AA%E3%83%B3%E3%82%B0%E3%83%90%E3%83%83%E3%83%81%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9[spring-batch チュートリアル => スプリングバッチの使い方^]
